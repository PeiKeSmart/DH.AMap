@{
    ViewBag.Title = "地理编码测试";
}

@section Styles {
<style>
    .form-container {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 4px;
        margin-top: 20px;
    }
    .form-group {
        margin-bottom: 15px;
    }
    .form-group label {
        display: inline-block;
        width: 120px;
        font-weight: bold;
    }
    .form-group input {
        width: 500px;
        padding: 8px;
        border: 1px solid #dcdfe6;
        border-radius: 4px;
    }
    .btn {
        background: #409EFF;
        color: white;
        border: none;
        padding: 10px 30px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-top: 10px;
    }
    .btn:hover {
        background: #66b1ff;
    }
    .result-container {
        margin-top: 30px;
        padding: 20px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .result-title {
        font-weight: bold;
        color: #303133;
        margin-bottom: 15px;
        font-size: 16px;
    }
    .result-item {
        padding: 10px;
        margin-bottom: 10px;
        background: #f5f7fa;
        border-left: 3px solid #409EFF;
    }
    .result-item strong {
        color: #606266;
    }
    #map {
        width: 100%;
        height: 400px;
        margin-top: 20px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .test-info {
        background: #e8f4fd;
        padding: 15px;
        margin-top: 20px;
        border-left: 4px solid #409EFF;
        border-radius: 4px;
    }
</style>
}

<h2>地理编码测试</h2>

<div class="test-info">
    <h3>测试说明</h3>
    <p>地理编码是指将地址转换为经纬度坐标的过程。本页面通过代理接口 <code>/_AMapService/v3/geocode/geo</code> 调用高德地图地理编码 API。</p>
    <ul style="margin: 10px 0; padding-left: 20px; line-height: 1.8;">
        <li>输入地址（如：北京市朝阳区阜通东大街6号）</li>
        <li>可选输入城市（如：北京、010）</li>
        <li>点击"查询"按钮获取经纬度坐标</li>
        <li>结果会在地图上标注</li>
    </ul>
</div>

<div class="form-container">
    <div class="form-group">
        <label>地址：</label>
        <input type="text" id="address" placeholder="请输入地址，例如：北京市朝阳区阜通东大街6号" value="北京市朝阳区阜通东大街6号">
    </div>
    <div class="form-group">
        <label>城市：</label>
        <input type="text" id="city" placeholder="可选，例如：北京 或 010" value="北京">
    </div>
    <button class="btn" onclick="geocode()">查询</button>
</div>

<div id="map" style="display: none;"></div>

<div class="result-container" id="resultContainer" style="display: none;">
    <div class="result-title">查询结果</div>
    <div id="resultContent"></div>
</div>

@section Scripts {
<script src="/_AMapService/maps?v=2.0"></script>
<script>
    var map = null;
    var markers = [];

    // 初始化地图
    function initMap() {
        if (!map) {
            map = new AMap.Map('map', {
                zoom: 15,
                center: [116.397428, 39.90923],
                viewMode: '2D'
            });
            document.getElementById('map').style.display = 'block';
        }
    }

    // 地理编码查询
    async function geocode() {
        var address = document.getElementById('address').value;
        var city = document.getElementById('city').value;

        if (!address) {
            alert('请输入地址');
            return;
        }

        try {
            // 构建查询参数
            var params = new URLSearchParams({
                address: address
            });

            if (city) {
                params.append('city', city);
            }

            // 调用代理接口
            var url = '/_AMapService/v3/geocode/geo?' + params.toString();
            console.log('请求URL：', url);

            var response = await fetch(url);
            var data = await response.json();

            console.log('返回数据：', data);

            // 显示结果
            displayResult(data);

        } catch (error) {
            console.error('查询失败：', error);
            alert('查询失败：' + error.message);
        }
    }

    // 显示结果
    function displayResult(data) {
        var resultContainer = document.getElementById('resultContainer');
        var resultContent = document.getElementById('resultContent');

        if (data.status !== '1') {
            resultContent.innerHTML = '<div class="result-item" style="border-left-color: #f56c6c;">查询失败：' + (data.info || '未知错误') + '</div>';
            resultContainer.style.display = 'block';
            return;
        }

        if (!data.geocodes || data.geocodes.length === 0) {
            resultContent.innerHTML = '<div class="result-item" style="border-left-color: #e6a23c;">未找到匹配的地址</div>';
            resultContainer.style.display = 'block';
            return;
        }

        // 初始化地图
        initMap();

        // 清除之前的标记
        if (markers.length > 0) {
            map.remove(markers);
            markers = [];
        }

        // 显示所有结果
        var html = '';
        data.geocodes.forEach(function(item, index) {
            var location = item.location.split(',');
            var lng = parseFloat(location[0]);
            var lat = parseFloat(location[1]);

            html += '<div class="result-item">';
            html += '<strong>结果 ' + (index + 1) + '</strong><br>';
            html += '地址：' + item.formatted_address + '<br>';
            html += '经度：' + lng.toFixed(6) + '<br>';
            html += '纬度：' + lat.toFixed(6) + '<br>';
            html += '置信度：' + item.level + '<br>';
            html += '</div>';

            // 在地图上添加标记
            var marker = new AMap.Marker({
                position: [lng, lat],
                title: item.formatted_address,
                label: {
                    content: (index + 1).toString(),
                    direction: 'top'
                }
            });

            map.add(marker);
            markers.push(marker);

            // 第一个结果设置为中心点
            if (index === 0) {
                map.setCenter([lng, lat]);
            }
        });

        resultContent.innerHTML = html;
        resultContainer.style.display = 'block';

        // 调整地图视野以显示所有标记
        if (markers.length > 1) {
            map.setFitView();
        }
    }
</script>
}
